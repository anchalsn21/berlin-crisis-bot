version: "3.1"

rules:

- rule: Start new session with greeting
  steps:
    - action: action_session_start
    - action: utter_greet
    - action: action_handle_greet

- rule: Handle greet intent anytime
  steps:
    - intent: greet
    - action: utter_greet
    - action: action_handle_greet


- rule: Handle earthquake report anytime (only if not already in earthquake flow)
  condition:
    - slot_was_set:
        - status_asked: false
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - slot_was_set:
        - emergency_type: earthquake
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status

- rule: Handle flood report anytime
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - slot_was_set:
        - emergency_type: flood
    - action: utter_acknowledge_flood
    - action: utter_ask_location

- rule: Handle fire report anytime
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - slot_was_set:
        - emergency_type: fire
    - action: utter_acknowledge_fire
    - action: utter_ask_location

- rule: Handle goodbye anytime
  steps:
    - intent: goodbye
    - action: utter_goodbye

- rule: Handle out of scope
  steps:
    - intent: out_of_scope
    - action: utter_out_of_scope

- rule: Handle request emergency type anytime
  steps:
    - intent: request_emergency_type
    - action: action_reset_emergency_slots
    - slot_was_set:
        - emergency_type: null
    - action: utter_ask_emergency_type

- rule: Handle request shelter info anytime
  steps:
    - intent: request_shelter_info
    - action: action_handle_shelter_request

- rule: Handle request emergency contacts anytime
  steps:
    - intent: request_emergency_contacts
    - action: utter_emergency_contacts

- rule: Handle request safety instructions anytime
  steps:
    - intent: request_safety_instructions
    - action: action_provide_safety_instructions

# Note: Status responses (injured/trapped/safe) are handled by stories to allow complete flow control
# Stories handle: status -> action_assess_status -> escalation -> location -> shelters -> conclusion
# The stories include nlu_fallback handling when status_asked is true, allowing action_assess_status
# to extract status from text even if NLU misclassifies the intent
