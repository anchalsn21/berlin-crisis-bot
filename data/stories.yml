version: "3.1"

stories:

- story: greet and ask emergency type
  steps:
    - intent: greet
    - action: utter_greet
    - action: action_handle_greet

- story: user provides emergency type - earthquake
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - slot_was_set:
        - emergency_type: earthquake
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status

- story: user provides emergency type - flood
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - slot_was_set:
        - emergency_type: flood
    - action: utter_acknowledge_flood
    - action: utter_ask_location

- story: user provides emergency type - fire
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - slot_was_set:
        - emergency_type: fire
    - action: utter_acknowledge_fire
    - action: utter_ask_location

# ============================================================================
# EARTHQUAKE EMERGENCY - STRICT FLOW
# ============================================================================

# Flow: Earthquake -> Instructions -> Status -> Safe -> Conclusion (NO location needed)
- story: earthquake - safe - conclusion flow
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_safe
    - action: action_assess_status
    - action: utter_anything_else

# Flow: Earthquake -> Instructions -> Status -> Injured -> Critical Response -> Location -> Shelters -> Conclusion
- story: earthquake - injured - complete flow
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_injured
    - action: action_assess_status
    - slot_was_set:
        - injury_status: injured
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_ask_location_critical
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

# Flow: Earthquake -> Instructions -> Status -> Trapped -> Critical Response -> Location -> Shelters -> Conclusion
- story: earthquake - trapped - complete flow
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_trapped
    - action: action_assess_status
    - slot_was_set:
        - injury_status: trapped
    - action: action_escalate_emergency
    - action: utter_trapped_response
    - action: utter_ask_location_critical
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

# Fallback: When status is expected but NLU classifies as nlu_fallback
# action_assess_status will extract status from text and set injury_status slot
# These stories handle the complete flow starting from earthquake report
- story: earthquake - nlu_fallback after status - injured flow
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - slot_was_set:
        - status_asked: true
    - intent: nlu_fallback
    - action: action_assess_status
    - slot_was_set:
        - injury_status: injured
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_ask_location_critical
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

- story: earthquake - nlu_fallback after status - trapped flow
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - slot_was_set:
        - status_asked: true
    - intent: nlu_fallback
    - action: action_assess_status
    - slot_was_set:
        - injury_status: trapped
    - action: action_escalate_emergency
    - action: utter_trapped_response
    - action: utter_ask_location_critical
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

- story: earthquake - nlu_fallback after status - safe flow
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - slot_was_set:
        - status_asked: true
    - intent: nlu_fallback
    - action: action_assess_status
    - slot_was_set:
        - injury_status: safe
    - action: utter_anything_else

# Fallback: When location is expected but user provides something else
- story: earthquake - fallback after location question
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_injured
    - action: action_assess_status
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_ask_location_critical
    - intent: nlu_fallback
    - action: utter_fallback_location_expected
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

# Invalid location retry for injured/trapped flow
- story: earthquake - injured - invalid location retry
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_injured
    - action: action_assess_status
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_ask_location_critical
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: false
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

- story: earthquake - trapped - invalid location retry
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_trapped
    - action: action_assess_status
    - action: action_escalate_emergency
    - action: utter_trapped_response
    - action: utter_ask_location_critical
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: false
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else


# ============================================================================
# FLOOD EMERGENCY - STRICT LINEAR FLOW
# ============================================================================

# Flow: Flood -> Location -> Instructions -> Shelters -> Status -> Safe -> Conclusion
- story: flood - safe - complete flow
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_flood
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_safe
    - action: action_assess_status
    - action: utter_anything_else

# Flow: Flood -> Location -> Instructions -> Shelters -> Status -> Injured -> Critical Response -> Conclusion
- story: flood - injured - complete flow
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_flood
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_injured
    - action: action_assess_status
    - slot_was_set:
        - injury_status: injured
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_anything_else

# Flow: Flood -> Location -> Instructions -> Shelters -> Status -> Trapped -> Critical Response -> Conclusion
- story: flood - trapped - complete flow
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_flood
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_trapped
    - action: action_assess_status
    - slot_was_set:
        - injury_status: trapped
    - action: action_escalate_emergency
    - action: utter_trapped_response
    - action: utter_anything_else

# Fallback: When status is expected but NLU classifies as nlu_fallback (flood)
- story: flood - nlu_fallback after status - injured flow
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_flood
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - slot_was_set:
        - status_asked: true
    - intent: nlu_fallback
    - action: action_assess_status
    - slot_was_set:
        - injury_status: injured
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_anything_else

- story: flood - nlu_fallback after status - trapped flow
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_flood
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - slot_was_set:
        - status_asked: true
    - intent: nlu_fallback
    - action: action_assess_status
    - slot_was_set:
        - injury_status: trapped
    - action: action_escalate_emergency
    - action: utter_trapped_response
    - action: utter_anything_else

- story: flood - invalid location - retry
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_flood
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: false
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_safe
    - action: action_assess_status
    - action: utter_anything_else


# ============================================================================
# FIRE EMERGENCY - STRICT LINEAR FLOW
# ============================================================================

# Flow: Fire -> Location -> Instructions -> Shelters -> Status -> Safe -> Conclusion
- story: fire - safe - complete flow
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_fire
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_safe
    - action: action_assess_status
    - action: utter_anything_else

# Flow: Fire -> Location -> Instructions -> Shelters -> Status -> Injured -> Critical Response -> Conclusion
- story: fire - injured - complete flow
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_fire
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_injured
    - action: action_assess_status
    - slot_was_set:
        - injury_status: injured
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_anything_else

# Flow: Fire -> Location -> Instructions -> Shelters -> Status -> Trapped -> Critical Response -> Conclusion
- story: fire - trapped - complete flow
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_fire
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_trapped
    - action: action_assess_status
    - slot_was_set:
        - injury_status: trapped
    - action: action_escalate_emergency
    - action: utter_trapped_response
    - action: utter_anything_else

# Fallback: When status is expected but NLU classifies as nlu_fallback (fire)
- story: fire - nlu_fallback after status - injured flow
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_fire
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - slot_was_set:
        - status_asked: true
    - intent: nlu_fallback
    - action: action_assess_status
    - slot_was_set:
        - injury_status: injured
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_anything_else

- story: fire - nlu_fallback after status - trapped flow
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_fire
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - slot_was_set:
        - status_asked: true
    - intent: nlu_fallback
    - action: action_assess_status
    - slot_was_set:
        - injury_status: trapped
    - action: action_escalate_emergency
    - action: utter_trapped_response
    - action: utter_anything_else

- story: fire - invalid location - retry
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_fire
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: false
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_safe
    - action: action_assess_status
    - action: utter_anything_else


- story: fallback - ask for emergency type
  steps:
    - intent: nlu_fallback
    - action: utter_default_fallback

- story: out of scope
  steps:
    - intent: out_of_scope
    - action: utter_out_of_scope

- story: goodbye
  steps:
    - intent: goodbye
    - action: utter_goodbye

- story: goodbye after shelters shown
  steps:
    - slot_was_set:
        - shelters_shown: true
    - intent: goodbye
    - action: utter_goodbye

- story: goodbye after safety instructions shown
  steps:
    - slot_was_set:
        - instructions_provided: true
    - intent: goodbye
    - action: utter_goodbye

- story: request emergency contacts
  steps:
    - intent: request_emergency_contacts
    - action: utter_emergency_contacts

- story: request shelter info - no emergency type
  steps:
    - intent: request_shelter_info
    - action: action_handle_shelter_request

# Handle location input after shelter request (when location was asked via followup)
# These stories handle what happens after action_handle_shelter_request triggers utter_ask_location
- story: provide location after shelter request
  steps:
    - action: utter_ask_location
    - intent: inform_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

# Handle location text input after shelter request (no inform_location intent)
- story: provide location text after shelter request
  steps:
    - action: utter_ask_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

# Note: request_safety_instructions and request_shelter_info are handled by rules
# Rules handle these "anytime" requests and end with action_listen
# Stories are only for specific flow scenarios, not general "anytime" requests


- story: earthquake - injured - GPS location sharing
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_injured
    - action: action_assess_status
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_ask_location_critical
    - intent: share_gps_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

# Handle location text input after critical location question (injured) - no inform_location intent
- story: earthquake - injured - location text only
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_injured
    - action: action_assess_status
    - action: action_escalate_emergency
    - action: utter_injured_response
    - action: utter_ask_location_critical
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

# Handle location text input after critical location question (trapped) - no inform_location intent
- story: earthquake - trapped - location text only
  steps:
    - intent: report_earthquake
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_earthquake
    - action: action_provide_earthquake_instructions_immediate
    - action: action_ask_status
    - intent: report_trapped
    - action: action_assess_status
    - action: action_escalate_emergency
    - action: utter_trapped_response
    - action: utter_ask_location_critical
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_find_nearest_shelters
    - action: utter_anything_else

- story: flood - GPS location sharing
  steps:
    - intent: report_flood
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_flood
    - action: utter_ask_location
    - intent: share_gps_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_safe
    - action: action_assess_status
    - action: utter_anything_else

- story: fire - GPS location sharing
  steps:
    - intent: report_fire
    - action: action_reset_emergency_slots
    - action: utter_acknowledge_fire
    - action: utter_ask_location
    - intent: share_gps_location
    - action: action_validate_location
    - slot_was_set:
        - location_validated: true
    - action: action_provide_safety_instructions
    - action: action_find_nearest_shelters
    - action: action_ask_status
    - intent: report_safe
    - action: action_assess_status
    - action: utter_anything_else
